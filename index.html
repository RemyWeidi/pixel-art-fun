<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier Pixel Art Pro - Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': '#06b6d4',
                        'accent-dark': '#0e7490', 
                        'soft-bg': '#f8fafc', 
                        'text-dark': '#1e293b', 
                    }
                }
            }
        }
    </script>
    <style>
        /* --- BASE & RESET --- */
        body { overscroll-behavior-y: none; touch-action: none; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .no-context-menu { -webkit-touch-callout: none; user-select: none; }

        /* --- WORKSPACE --- */
        #workspace {
            width: 100%; height: 100vh; 
            background-color: #e5e7eb; 
            position: relative; display: flex; align-items: center; justify-content: center; 
            overflow: hidden;
        }

        #canvas-wrapper {
            position: relative; background-color: white; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 500px; height: 500px; flex-shrink: 0;
            image-rendering: pixelated; cursor: crosshair;
            transition: transform 0.05s linear; 
        }

        #reference-image {
            position: absolute; inset: 0; 
            background-size: contain; background-position: center; background-repeat: no-repeat;
            opacity: 0; pointer-events: none; z-index: 0; transition: opacity 0.2s;
        }
        
        #pixel-grid { 
            position: relative; z-index: 10; width: 100%; height: 100%; touch-action: none; display: grid;
        }
        
        .pixel { width: 100%; height: 100%; background-color: white; box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.05); }
        .no-grid .pixel { box-shadow: none !important; }

        /* --- UI STYLES --- */
        .tool-btn { 
            @apply bg-white border border-gray-200 hover:bg-gray-50 transition-all duration-150 flex items-center justify-center text-gray-600; 
            height: 48px; width: 100%; border-radius: 0.75rem; font-size: 1.1rem;
        }
        .tool-active { 
            background-color: #e0f2fe !important; border-color: #06b6d4 !important; color: #06b6d4 !important; 
            border-width: 2px !important; transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(6, 182, 212, 0.2);
        }

        /* Floating Undo/Redo Mobile */
        .floating-actions {
            position: fixed; top: 16px; left: 16px; z-index: 50; display: flex; gap: 8px;
        }
        .float-btn {
            width: 44px; height: 44px; background: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #4b5563; font-size: 18px;
        }
        .float-btn:active { transform: scale(0.95); background: #f3f4f6; }
        .float-btn:disabled { opacity: 0.5; color: #9ca3af; }

        /* --- RESPONSIVE --- */
        .mobile-flex { display: none; }
        .desktop-only { display: block; }
        
        @media (max-width: 1024px) {
            .mobile-flex { display: flex; }
            .desktop-only { display: none !important; }
            #workspace { background-color: #f8fafc; height: 100%; } 
        }
        
        @media (min-width: 1025px) {
            #workspace { width: calc(100% - 320px); margin-left: 320px; }
            .floating-actions { display: none; } /* Caché sur PC car dans la sidebar */
        }

        /* Menu Mobile */
        #main-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: white;
            justify-content: space-around; align-items: center; padding: 0 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 50; border-top: 1px solid #f3f4f6;
        }
        .btn-xl {
            height: 56px; width: 56px; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center;
            background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s;
            font-size: 24px; color: #4b5563;
        }
        .btn-xl.active { background-color: #e0f2fe; border: 2px solid #06b6d4; color: #06b6d4; }

        #mobile-tools-panel {
            position: fixed; bottom: 80px; left: 0; right: 0;
            background: white; border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 24px; box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            transform: translateY(120%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 60; max-height: 80vh; overflow-y: auto; padding-bottom: 100px;
        }
        #mobile-tools-panel.open { transform: translateY(0); }
        
        .btn-mobile-menu {
            height: 50px; width: 100%; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; background: #f9fafb; color: #4b5563; border: 1px solid #e5e7eb;
        }
        .btn-mobile-menu.active-tool { background-color: #06b6d4 !important; color: white !important; border: none; }

        /* Color Picker Wrapper */
        .native-picker-wrapper { position: relative; overflow: hidden; height: 100px; width: 100%; border-radius: 1rem; }
        input[type="color"] { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; padding: 0; margin: 0; cursor: pointer; border: none; }
    </style>
</head>
<body class="bg-soft-bg text-text-dark no-context-menu">

    <div class="floating-actions">
        <button id="mobUndoFloat" class="float-btn" onclick="undo()"><i class="fa-solid fa-rotate-left"></i></button>
        <button id="mobRedoFloat" class="float-btn" onclick="redo()"><i class="fa-solid fa-rotate-right"></i></button>
    </div>

    <div id="workspace">
        <div id="canvas-wrapper">
            <div id="reference-image"></div>
            <div id="pixel-grid"></div>
        </div>
    </div>

    <div id="main-bar" class="mobile-flex">
        <button id="mobBrush" class="btn-xl active" onclick="setTool('brush')"><i class="fa-solid fa-paintbrush"></i></button>
        <button id="mobFill" class="btn-xl" onclick="setTool('fill')"><i class="fa-solid fa-fill-drip"></i></button>
        <button id="mobEraser" class="btn-xl" onclick="setTool('eraser')"><i class="fa-solid fa-eraser"></i></button>
        <button id="mobColorBtn" class="w-14 h-14 rounded-full border-4 border-gray-100 shadow-lg bg-primary" onclick="openColorModal()"></button>
        <button id="mobMenuBtn" class="btn-xl bg-gray-800 text-white" onclick="toggleMobileMenu()"><i class="fa-solid fa-ellipsis"></i></button>
    </div>

    <div id="mobile-tools-panel">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6" onclick="closeMobileMenu()"></div>
        
        <div id="mobImageControls" class="hidden mb-6 bg-blue-50 p-4 rounded-2xl border border-blue-100">
            <div class="flex justify-between items-center mb-2 text-xs font-bold text-blue-600 uppercase">
                <span>Image de fond</span>
                <button id="mobImgToggle" onclick="toggleImageVisibility()" class="p-2 bg-white rounded-lg shadow-sm border border-blue-100"><i class="fa-solid fa-eye"></i></button>
            </div>
            <input type="range" min="0" max="100" value="70" class="w-full h-4 bg-blue-200 rounded-full accent-blue-600" oninput="setRefOpacity(this.value)">
        </div>

        <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Actions</h3>
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button class="btn-mobile-menu bg-blue-50 text-blue-600 border-blue-100 font-bold text-sm" onclick="pixeliseImage()">
                <i class="fa-solid fa-wand-sparkles mr-2"></i> Pixeliser
            </button>
            <button class="btn-mobile-menu bg-gray-800 text-white font-bold text-sm" onclick="exportCanvas()">
                <i class="fa-solid fa-download mr-2"></i> Exporter
            </button>
        </div>

        <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Outils Avancés</h3>
        <div class="grid grid-cols-4 gap-2 mb-6">
            <button id="mobPipette" class="btn-mobile-menu" onclick="setTool('pipette'); closeMobileMenu();"><i class="fa-solid fa-eye-dropper"></i></button>
            <button id="mobMagicWand" class="btn-mobile-menu" onclick="setTool('magicWand'); closeMobileMenu();"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            <button id="mobSymBtn" class="btn-mobile-menu" onclick="toggleSymmetry()"><i class="fa-solid fa-right-left"></i></button>
            <button id="mobGridBtn" class="btn-mobile-menu" onclick="toggleGrid()"><i class="fa-solid fa-border-all"></i></button>
        </div>

        <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Formes</h3>
        <div class="grid grid-cols-3 gap-2 mb-6">
            <button id="mobLine" class="btn-mobile-menu" onclick="setTool('line'); closeMobileMenu();"><i class="fa-solid fa-slash"></i></button>
            <button id="mobRect" class="btn-mobile-menu" onclick="setTool('rect'); closeMobileMenu();"><i class="fa-regular fa-square"></i></button>
            <button id="mobCircle" class="btn-mobile-menu" onclick="setTool('circle'); closeMobileMenu();"><i class="fa-regular fa-circle"></i></button>
        </div>

        <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Déplacer</h3>
        <div class="grid grid-cols-4 gap-2 mb-6">
             <button class="btn-mobile-menu" onclick="moveCanvas(0, -1)"><i class="fa-solid fa-arrow-up"></i></button>
             <button class="btn-mobile-menu" onclick="moveCanvas(0, 1)"><i class="fa-solid fa-arrow-down"></i></button>
             <button class="btn-mobile-menu" onclick="moveCanvas(-1, 0)"><i class="fa-solid fa-arrow-left"></i></button>
             <button class="btn-mobile-menu" onclick="moveCanvas(1, 0)"><i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div class="mb-6 bg-gray-50 p-4 rounded-2xl border border-gray-100">
             <span class="text-xs font-bold text-gray-500 uppercase block mb-2">
                 Taille Grille: <span id="mobGridVal" class="text-primary text-base">16x16</span>
            </span>
             <div class="flex gap-2 items-center">
                <input type="range" id="mobGridSize" min="4" max="64" step="4" value="16" class="flex-grow h-4 bg-gray-200 rounded-full accent-primary">
                <button id="mobApplyGrid" class="px-4 py-2 bg-primary text-white rounded-xl font-bold text-sm">OK</button>
             </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <label class="btn-mobile-menu cursor-pointer font-bold text-sm">
                <i class="fa-solid fa-upload mr-2"></i> Image
                <input type="file" id="mobileImageUpload" accept="image/*" class="hidden">
            </label>
            <button class="btn-mobile-menu text-red-500 border-red-100 bg-red-50 font-bold text-sm" onclick="createGrid(); closeMobileMenu();"><i class="fa-solid fa-trash mr-2"></i> Vider</button>
        </div>
    </div>

    <aside class="desktop-only fixed top-0 left-0 bottom-0 w-80 bg-white border-r border-gray-200 p-6 overflow-y-auto z-20 custom-scrollbar">
        
        <div class="flex gap-2 mb-6">
             <button id="undoBtn" onclick="undo()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold disabled:opacity-50" disabled title="Annuler (Ctrl+Z)"><i class="fa-solid fa-rotate-left"></i></button>
             <button id="redoBtn" onclick="redo()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold disabled:opacity-50" disabled title="Rétablir (Ctrl+Y)"><i class="fa-solid fa-rotate-right"></i></button>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6">
            <h2 class="text-xs font-bold text-gray-400 uppercase mb-3">Palette</h2>
            <button id="deskColorBtn" class="w-full h-10 rounded-xl shadow-inner flex items-center justify-center gap-2 text-white font-bold mb-4 transition hover:opacity-90" style="background-color: #06B6D4;" onclick="openColorModal()">
                <i class="fa-solid fa-palette"></i> Changer Couleur
            </button>
            <div id="deskRecentColors" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="grid grid-cols-4 gap-2 mb-4">
            <button id="deskBrush" class="tool-btn active" onclick="setTool('brush')" title="Pinceau (B)"><i class="fa-solid fa-paintbrush"></i></button>
            <button id="deskFill" class="tool-btn" onclick="setTool('fill')" title="Remplir (G)"><i class="fa-solid fa-fill-drip"></i></button>
            <button id="deskEraser" class="tool-btn" onclick="setTool('eraser')" title="Gomme (E)"><i class="fa-solid fa-eraser"></i></button>
            <button id="deskPipette" class="tool-btn" onclick="setTool('pipette')" title="Pipette (I)"><i class="fa-solid fa-eye-dropper"></i></button>
        </div>

        <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Formes & Magie</h3>
        <div class="grid grid-cols-4 gap-2 mb-6">
            <button id="deskLine" class="tool-btn" onclick="setTool('line')" title="Ligne (L)"><i class="fa-solid fa-slash"></i></button>
            <button id="deskRect" class="tool-btn" onclick="setTool('rect')" title="Rectangle (R)"><i class="fa-regular fa-square"></i></button>
            <button id="deskCircle" class="tool-btn" onclick="setTool('circle')" title="Cercle (C)"><i class="fa-regular fa-circle"></i></button>
            <button id="deskMagicWand" class="tool-btn" onclick="setTool('magicWand')" title="Baguette (W)"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
        </div>

        <div class="mb-6 bg-gray-50 p-3 rounded-xl border border-gray-100">
             <div class="flex justify-between text-xs font-bold text-gray-500 mb-2"><span>Taille Pinceau</span><span id="deskBrushVal" class="text-primary">1</span></div>
             <input type="range" id="deskBrushSize" min="1" max="4" value="1" class="w-full h-2 bg-gray-200 rounded-lg accent-primary cursor-pointer">
        </div>

        <div class="flex gap-2 mb-4">
            <button id="deskSymBtn" class="flex-1 py-2 border rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition" onclick="toggleSymmetry()"><i class="fa-solid fa-right-left"></i> Miroir</button>
            <button id="deskGridBtn" class="flex-1 py-2 border rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition" onclick="toggleGrid()"><i class="fa-solid fa-border-all"></i> Grille</button>
        </div>

        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 mb-6">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-2 text-center">Déplacer</h3>
            <div class="flex justify-center gap-2">
                <button onclick="moveCanvas(0, -1)" class="w-8 h-8 bg-white rounded shadow-sm hover:bg-gray-100"><i class="fa-solid fa-arrow-up"></i></button>
            </div>
            <div class="flex justify-center gap-8 my-1">
                <button onclick="moveCanvas(-1, 0)" class="w-8 h-8 bg-white rounded shadow-sm hover:bg-gray-100"><i class="fa-solid fa-arrow-left"></i></button>
                <button onclick="moveCanvas(1, 0)" class="w-8 h-8 bg-white rounded shadow-sm hover:bg-gray-100"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
            <div class="flex justify-center gap-2">
                <button onclick="moveCanvas(0, 1)" class="w-8 h-8 bg-white rounded shadow-sm hover:bg-gray-100"><i class="fa-solid fa-arrow-down"></i></button>
            </div>
        </div>

        <div class="space-y-3 pt-4 border-t border-gray-100">
             <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                 <div class="flex gap-2 mb-2">
                    <label class="flex-1 py-2 bg-white text-blue-600 rounded-lg text-center cursor-pointer font-bold text-xs border border-blue-200 hover:bg-blue-50 transition">
                        Charger
                        <input type="file" id="imageUpload" accept="image/*" class="hidden">
                    </label>
                    <button id="generatePixelArtBtn" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold text-xs hover:bg-blue-700 transition">Pixeliser</button>
                 </div>
                 <div id="deskImageControls" class="hidden mt-2">
                     <div class="flex justify-between items-center text-xs text-blue-400 mb-1 font-bold">
                         <span>Opacité Image</span>
                         <div class="flex items-center gap-2">
                             <span id="opacityVal">70%</span>
                             <button id="deskImgToggle" onclick="toggleImageVisibility()" class="bg-white p-1 rounded hover:bg-blue-50 text-blue-600"><i class="fa-solid fa-eye"></i></button>
                         </div>
                     </div>
                     <input type="range" id="gridOpacity" min="0" max="100" value="70" class="w-full h-2 bg-blue-200 rounded-lg accent-blue-600" oninput="setRefOpacity(this.value)">
                 </div>
             </div>

             <div class="flex items-center gap-2 mt-4">
                <span class="text-xs font-bold text-gray-400 uppercase whitespace-nowrap w-16">Grille: <br><span id="currentSize" class="text-primary text-sm">16x16</span></span>
                <input type="range" id="deskGridSize" min="4" max="64" value="16" step="4" class="flex-grow h-2 bg-gray-200 rounded-lg accent-primary">
                <button id="deskApplySize" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs font-bold transition">OK</button>
             </div>

             <div class="flex gap-2 mt-4">
                <button onclick="createGrid()" class="flex-1 py-3 text-red-500 border border-red-200 hover:bg-red-50 rounded-xl font-bold text-sm transition">Vider</button>
                <button onclick="exportCanvas()" class="flex-1 py-3 bg-gray-800 hover:bg-gray-900 text-white rounded-xl font-bold text-sm transition">PNG</button>
             </div>
        </div>
    </aside>

    <div id="colorModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] shadow-2xl p-6 w-full max-w-xs transform scale-100 transition-transform">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-text-dark">Couleur</h3>
                <button onclick="closeColorModal()" class="text-3xl text-gray-300 hover:text-gray-500">&times;</button>
            </div>
            <div class="flex gap-3 mb-4">
                <div id="modalColorPreview" class="w-14 h-14 rounded-xl border border-gray-200 shadow-sm shrink-0" style="background-color: #06B6D4;"></div>
                <div class="flex-grow">
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Code Hex</label>
                    <div class="flex items-center bg-gray-100 rounded-xl px-3 py-2 border border-transparent focus-within:border-primary focus-within:bg-white transition">
                        <span class="text-gray-400 font-bold mr-1">#</span>
                        <input type="text" id="modalHexInput" class="w-full bg-transparent outline-none font-mono font-bold text-gray-700 uppercase" value="06B6D4" maxlength="6">
                    </div>
                </div>
            </div>
            <div class="native-picker-wrapper mb-6 shadow-inner border border-gray-200 bg-gray-50">
                 <input type="color" id="nativeColorPicker" value="#06B6D4">
            </div>
            <div class="mb-4">
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-widest">Récentes</h4>
                <div id="modalRecentColors" class="flex flex-wrap gap-2"></div>
            </div>
             <div class="mb-6">
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-widest">Classiques</h4>
                <div id="modalPresetColors" class="flex flex-wrap gap-2"></div>
            </div>
            <button onclick="confirmColorModal()" class="w-full py-4 bg-primary hover:bg-accent-dark text-white font-bold rounded-2xl text-lg shadow-lg shadow-primary/30 transition active:scale-95">Valider</button>
        </div>
    </div>

    <script>
        const pixelGrid = document.getElementById('pixel-grid');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const refImage = document.getElementById('reference-image');
        let gridSize = 16;
        let currentTool = 'brush';
        let currentColor = "#06B6D4";
        let pendingColor = "#06B6D4";
        let isTransparent = false; 
        let isSymmetry = false;
        let isGridVisible = true;
        let brushSize = 1; 
        
        // Undo/Redo
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 30;

        // Zoom
        let scale = 1;
        let panning = false;
        let lastTouchX = 0, lastTouchY = 0;
        let initialPinchDist = 0;
        let translateX = 0, translateY = 0;

        // Image
        let currentRefImageObj = null;
        let refOpacity = 0.7;
        let isImageVisible = true;

        let recentColors = ["#06B6D4"];
        const PRESET_COLORS = ["#FACC15", "#3B82F6", "#22C55E", "#EF4444", "#FFFFFF", "#9CA3AF", "#000000"];

        window.onload = () => {
            createGrid();
            renderModalPalette();
            setupEvents();
            setupZoomPan(); 
            updateToolUI();
            updateGridText(gridSize, 'currentSize');
            updateGridText(gridSize, 'mobGridVal');
            setupShortcuts();
        };

        // --- LOGIQUE IMAGE ---
        function toggleImageVisibility() {
            if(!currentRefImageObj) return;
            isImageVisible = !isImageVisible;
            refImage.style.opacity = isImageVisible ? refOpacity : 0;
            
            const icon = isImageVisible ? '<i class="fa-solid fa-eye"></i>' : '<i class="fa-solid fa-eye-slash"></i>';
            document.getElementById('deskImgToggle').innerHTML = icon;
            document.getElementById('mobImgToggle').innerHTML = icon;
        }

        function setRefOpacity(val) {
            refOpacity = val / 100;
            if(isImageVisible) {
                refImage.style.opacity = refOpacity;
            }
            const disp = document.getElementById('opacityVal');
            if(disp) disp.textContent = val + '%';
        }

        function handleImageUpload(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = () => {
                const img = new Image();
                img.onload = () => {
                    currentRefImageObj = img;
                    refImage.style.backgroundImage = `url('${r.result}')`;
                    document.getElementById('deskImageControls').classList.remove('hidden');
                    document.getElementById('mobImageControls').classList.remove('hidden');
                    setRefOpacity(70);
                    // Par défaut, on rend la grille semi-transparente (blanche par defaut) pour voir l'image ? 
                    // Non, ici l'image est DERRIERE la grille. Les pixels par défaut sont blancs.
                    // Pour voir l'image, il faut que les pixels soient transparents ou qu'on réduise l'opacité du pixel-grid
                    pixelGrid.style.opacity = 0.8; // On met la grille un peu transparente pour aider au calque
                };
                img.src = r.result;
            };
            r.readAsDataURL(f);
            closeMobileMenu();
        }

        // --- GRILLE & HISTORIQUE ---
        function createGrid() {
            pixelGrid.innerHTML = ''; 
            pixelGrid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            for (let i = 0; i < gridSize * gridSize; i++) {
                const div = document.createElement('div');
                div.className = 'pixel';
                div.dataset.index = i;
                div.style.backgroundColor = 'white';
                pixelGrid.appendChild(div);
            }
            history = []; historyIndex = -1;
            saveState();
        }

        function saveState() {
            const state = Array.from(pixelGrid.children).map(p => p.style.backgroundColor);
            if (historyIndex < history.length - 1) history.splice(historyIndex + 1);
            history.push(state);
            if (history.length > MAX_HISTORY) history.shift(); else historyIndex++;
            updateUndoRedoUI();
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreState(history[historyIndex]);
                updateUndoRedoUI();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreState(history[historyIndex]);
                updateUndoRedoUI();
            }
        }

        function restoreState(state) {
            const pixels = pixelGrid.children;
            for(let i=0; i<pixels.length; i++) pixels[i].style.backgroundColor = state[i];
        }

        function updateUndoRedoUI() {
            const canUndo = historyIndex > 0;
            const canRedo = historyIndex < history.length - 1;
            document.getElementById('undoBtn').disabled = !canUndo;
            document.getElementById('redoBtn').disabled = !canRedo;
            document.getElementById('mobUndoFloat').disabled = !canUndo;
            document.getElementById('mobRedoFloat').disabled = !canRedo;
        }

        // --- DESSIN ---
        let isDrawing = false;
        let startPixel = null;

        function getPixel(x, y) {
            if(x < 0 || x >= gridSize || y < 0 || y >= gridSize) return null;
            return pixelGrid.children[y * gridSize + x];
        }
        function getCoords(index) { return { x: index % gridSize, y: Math.floor(index / gridSize) }; }

        function paintPixel(x, y, color) {
            let size = brushSize;
            let offset = Math.floor((size - 1) / 2);
            for (let dx = -offset; dx < size - offset; dx++) {
                for (let dy = -offset; dy < size - offset; dy++) {
                    let px = x + dx, py = y + dy;
                    const pixel = getPixel(px, py);
                    if(pixel) {
                        pixel.style.backgroundColor = color;
                        if(isSymmetry) {
                            const symPixel = getPixel(gridSize - 1 - px, py);
                            if(symPixel) symPixel.style.backgroundColor = color;
                        }
                    }
                }
            }
        }

        function handleStart(e) {
            if(e.target.closest('.zoom-controls') || e.target.closest('.floating-actions') || !e.target.closest('#pixel-grid')) return;
            e.preventDefault(); // Prevent default touch actions & context menu
            isDrawing = true;
            
            const pt = getPointerPos(e);
            if(!pt) return;
            startPixel = pt;

            // Clic droit = Gomme
            if(e.button === 2 || (e.buttons === 2)) {
                drawAction(pt, true); // Force Eraser
                return;
            }

            if (currentTool === 'fill') {
                fillTool(startPixel.x, startPixel.y, isTransparent ? 'transparent' : currentColor);
                saveState(); isDrawing = false;
            } else if (currentTool === 'magicWand') {
                magicWandAction(startPixel.x, startPixel.y);
                saveState(); isDrawing = false;
            } else if (currentTool === 'pipette') {
                const p = getPixel(startPixel.x, startPixel.y);
                if(p) setAppColor(p.style.backgroundColor);
                isDrawing = false;
            } else if (['brush', 'eraser'].includes(currentTool)) {
                drawAction(pt);
            }
        }

        function handleMove(e) {
            if(!isDrawing) return;
            const pt = getPointerPos(e);
            if(!pt) return;

            // Clic droit maintenu
            if(e.buttons === 2) {
                drawAction(pt, true);
                return;
            }

            if(['brush', 'eraser'].includes(currentTool)) {
                drawAction(pt);
            } else if (['line', 'rect', 'circle'].includes(currentTool)) {
                restoreState(history[historyIndex]);
                drawShape(startPixel, pt, currentTool);
            }
        }

        function handleEnd() {
            if(isDrawing) {
                saveState();
                isDrawing = false;
                startPixel = null;
            }
        }

        function getPointerPos(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const target = document.elementFromPoint(clientX, clientY);
            if(target && target.classList.contains('pixel')) {
                return getCoords(parseInt(target.dataset.index));
            }
            return null;
        }

        function drawAction(coords, forceEraser = false) {
            const color = (currentTool === 'eraser' || isTransparent || forceEraser) ? 'transparent' : currentColor;
            paintPixel(coords.x, coords.y, color);
        }

        // --- ALGORITHMES FORMES ---
        function drawShape(start, end, type) {
            const color = isTransparent ? 'transparent' : currentColor;
            if(type === 'line') {
                let x0 = start.x, y0 = start.y, x1 = end.x, y1 = end.y;
                let dx = Math.abs(x1-x0), sx = x0<x1 ? 1 : -1;
                let dy = -Math.abs(y1-y0), sy = y0<y1 ? 1 : -1;
                let err = dx+dy;
                while(true){
                    paintPixel(x0, y0, color); if (x0===x1 && y0===y1) break;
                    let e2 = 2*err; if (e2 >= dy) { err += dy; x0 += sx; } if (e2 <= dx) { err += dx; y0 += sy; }
                }
            } else if (type === 'rect') {
                let x1 = Math.min(start.x, end.x), x2 = Math.max(start.x, end.x);
                let y1 = Math.min(start.y, end.y), y2 = Math.max(start.y, end.y);
                for(let x=x1; x<=x2; x++) { paintPixel(x, y1, color); paintPixel(x, y2, color); }
                for(let y=y1; y<=y2; y++) { paintPixel(x1, y, color); paintPixel(x2, y, color); }
            } else if (type === 'circle') {
                let r = Math.round(Math.sqrt(Math.pow(end.x-start.x, 2) + Math.pow(end.y-start.y, 2)));
                let xc = start.x, yc = start.y, x = 0, y = r, d = 3 - 2 * r;
                const drawC = (x,y) => {
                    paintPixel(xc+x, yc+y, color); paintPixel(xc-x, yc+y, color);
                    paintPixel(xc+x, yc-y, color); paintPixel(xc-x, yc-y, color);
                    paintPixel(xc+y, yc+x, color); paintPixel(xc-y, yc+x, color);
                    paintPixel(xc+y, yc-x, color); paintPixel(xc-y, yc-x, color);
                };
                while(y >= x) { drawC(x, y); x++; if(d > 0) { y--; d = d + 4 * (x - y) + 10; } else { d = d + 4 * x + 6; } }
            }
        }

        function fillTool(x, y, color) {
            const targetPixel = getPixel(x, y);
            const targetColor = targetPixel.style.backgroundColor;
            if(targetColor === color) return;
            const stack = [[x, y]];
            while(stack.length) {
                const [cx, cy] = stack.pop();
                const p = getPixel(cx, cy);
                if(p && p.style.backgroundColor === targetColor) {
                    p.style.backgroundColor = color;
                    stack.push([cx+1, cy], [cx-1, cy], [cx, cy+1], [cx, cy-1]);
                }
            }
        }

        function magicWandAction(x, y) {
            const targetPixel = getPixel(x, y);
            const targetColor = targetPixel.style.backgroundColor;
            if(targetColor === 'transparent' || targetColor === 'rgba(0, 0, 0, 0)') return;
            fillTool(x, y, 'transparent');
        }

        function moveCanvas(dx, dy) {
            const current = history[historyIndex] || Array.from(pixelGrid.children).map(p=>p.style.backgroundColor);
            const next = new Array(gridSize*gridSize).fill('transparent');
            for(let y=0; y<gridSize; y++) {
                for(let x=0; x<gridSize; x++) {
                    let nx = x + dx, ny = y + dy;
                    if(nx >= 0 && nx < gridSize && ny >= 0 && ny < gridSize) {
                        next[ny*gridSize + nx] = current[y*gridSize + x];
                    }
                }
            }
            restoreState(next); saveState();
        }

        // --- UI & TOOLS ---
        function setTool(t) {
            currentTool = t;
            isTransparent = (t === 'eraser');
            updateToolUI();
        }

        function updateToolUI() {
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('tool-active'));
            const deskBtn = document.getElementById(`desk${capitalize(currentTool)}`);
            if(deskBtn) deskBtn.classList.add('tool-active');

            document.querySelectorAll('.btn-xl').forEach(b => b.classList.remove('active'));
            const mobBtn = document.getElementById(`mob${capitalize(currentTool)}`);
            if(mobBtn) mobBtn.classList.add('active');
            
            document.querySelectorAll('.btn-mobile-menu').forEach(b => b.classList.remove('active-tool'));
            const menuBtn = document.getElementById(`mob${capitalize(currentTool)}`);
            if(menuBtn) menuBtn.classList.add('active-tool');
            
            const updateToggle = (id, state) => {
                const el = document.getElementById(id);
                if(el) {
                    if(state) { el.classList.add('bg-primary', 'text-white'); el.classList.remove('bg-white', 'text-gray-600'); }
                    else { el.classList.remove('bg-primary', 'text-white'); }
                }
            };
            updateToggle('deskSymBtn', isSymmetry); updateToggle('mobSymBtn', isSymmetry);
            updateToggle('deskGridBtn', isGridVisible); updateToggle('mobGridBtn', isGridVisible);
            pixelGrid.classList.toggle('no-grid', !isGridVisible);
        }
        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
        function toggleSymmetry() { isSymmetry = !isSymmetry; updateToolUI(); }
        function toggleGrid() { isGridVisible = !isGridVisible; updateToolUI(); }

        // --- COULEUR ---
        function setAppColor(hex) {
            if(hex.startsWith('rgb')) {
                 let a = hex.match(/\d+/g); if(!a) return;
                 hex = "#" + ((1<<24)+(+a[0]<<16)+(+a[1]<<8)+ +a[2]).toString(16).slice(1).toUpperCase();
            }
            if(hex === 'transparent') return;
            currentColor = hex;
            document.getElementById('mobColorBtn').style.backgroundColor = currentColor;
            document.getElementById('deskColorBtn').style.backgroundColor = currentColor;
            if(!recentColors.includes(currentColor)) {
                recentColors.unshift(currentColor);
                if(recentColors.length > 8) recentColors.pop();
                renderModalPalette(); renderDeskPalette();
            }
            if(currentTool === 'eraser') setTool('brush');
        }

        function openColorModal() {
            pendingColor = currentColor;
            updateModalPreview(pendingColor);
            document.getElementById('colorModal').classList.remove('hidden');
        }
        function closeColorModal() { document.getElementById('colorModal').classList.add('hidden'); }
        function confirmColorModal() { setAppColor(pendingColor); closeColorModal(); }
        
        function updateModalPreview(hex) {
            if(!/^#[0-9A-F]{6}$/i.test(hex) && !hex.startsWith('#')) return; 
            pendingColor = hex;
            document.getElementById('modalColorPreview').style.backgroundColor = hex;
            document.getElementById('nativeColorPicker').value = hex;
            if(hex.startsWith('#')) document.getElementById('modalHexInput').value = hex.substring(1);
        }

        function renderModalPalette() {
            const mkSwatch = (c, container) => {
                const d = document.createElement('div'); d.className = `w-8 h-8 rounded-full cursor-pointer border border-gray-200 hover:scale-110 transition`; 
                d.style.backgroundColor = c; d.onclick = () => updateModalPreview(c); container.appendChild(d);
            };
            const recents = document.getElementById('modalRecentColors');
            const presets = document.getElementById('modalPresetColors');
            recents.innerHTML = ''; presets.innerHTML = ''; 
            recentColors.forEach(c => mkSwatch(c, recents)); PRESET_COLORS.forEach(c => mkSwatch(c, presets));
            renderDeskPalette();
        }
        function renderDeskPalette() {
            const deskRecents = document.getElementById('deskRecentColors'); if(!deskRecents) return;
            deskRecents.innerHTML = '';
            recentColors.forEach(c => {
                const d = document.createElement('div'); d.className = `w-6 h-6 rounded-full cursor-pointer border border-gray-200`; 
                d.style.backgroundColor = c; d.onclick = () => setAppColor(c); deskRecents.appendChild(d);
            });
        }

        // --- PIXELISATION & EXPORT ---
        function pixeliseImage() {
            if(!currentRefImageObj) { alert("Chargez une image d'abord !"); return; }
            const c = document.createElement('canvas'); c.width = gridSize; c.height = gridSize;
            const ctx = c.getContext('2d');
            ctx.drawImage(currentRefImageObj, 0, 0, gridSize, gridSize);
            const data = ctx.getImageData(0,0,gridSize,gridSize).data;
            const newState = [];
            for(let i=0; i<data.length; i+=4) {
                 if(data[i+3] < 100) newState.push('transparent');
                 else newState.push("#" + ((1<<24)+(data[i]<<16)+(data[i+1]<<8)+data[i+2]).toString(16).slice(1));
            }
            restoreState(newState); saveState();
            pixelGrid.style.opacity = 1; // Remet l'opacité à 100 pour voir le pixel art
            closeMobileMenu();
        }
        function exportCanvas() {
             const c = document.createElement('canvas'); c.width=gridSize*20; c.height=gridSize*20;
             const ctx = c.getContext('2d');
             Array.from(pixelGrid.children).forEach((p,i) => {
                 const col = p.style.backgroundColor;
                 if(col && col !== 'transparent' && col !== 'rgba(0, 0, 0, 0)' && col !== 'white') {
                     ctx.fillStyle = col; ctx.fillRect((i%gridSize)*20, Math.floor(i/gridSize)*20, 20, 20);
                 }
             });
             const a = document.createElement('a'); a.download = 'pixelart.png'; a.href = c.toDataURL(); a.click();
             closeMobileMenu();
        }
        function updateGridText(val, id) { const el = document.getElementById(id); if(el) el.textContent = `${val}x${val}`; }

        // --- SETUP EVENTS ---
        function setupEvents() {
            pixelGrid.addEventListener('pointerdown', handleStart);
            window.addEventListener('pointermove', handleMove);
            window.addEventListener('pointerup', handleEnd);
            document.getElementById('canvas-wrapper').oncontextmenu = (e) => e.preventDefault();

            document.getElementById('imageUpload').onchange = handleImageUpload;
            document.getElementById('mobileImageUpload').onchange = handleImageUpload;
            document.getElementById('nativeColorPicker').oninput = (e) => updateModalPreview(e.target.value);
            document.getElementById('modalHexInput').oninput = (e) => { if(e.target.value.length === 6) updateModalPreview('#'+e.target.value); };

            const applySize = (id) => { gridSize = parseInt(document.getElementById(id).value); createGrid(); };
            document.getElementById('deskApplySize').onclick = () => applySize('deskGridSize');
            document.getElementById('mobApplyGrid').onclick = () => { applySize('mobGridSize'); closeMobileMenu(); };
            document.getElementById('deskGridSize').oninput = (e) => updateGridText(e.target.value, 'currentSize');
            document.getElementById('mobGridSize').oninput = (e) => updateGridText(e.target.value, 'mobGridVal');
            
            document.getElementById('deskBrushSize').oninput = (e) => { brushSize = parseInt(e.target.value); document.getElementById('deskBrushVal').textContent = brushSize; };
            document.getElementById('generatePixelArtBtn').onclick = pixeliseImage;
        }
        
        function toggleMobileMenu() { document.getElementById('mobile-tools-panel').classList.toggle('open'); }
        function closeMobileMenu() { document.getElementById('mobile-tools-panel').classList.remove('open'); }

        // --- SHORTCUTS ---
        function setupShortcuts() {
            window.addEventListener('keydown', (e) => {
                if(e.target.tagName === 'INPUT') return;
                if(e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
                else if(e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
                else if(e.key.toLowerCase() === 'b') setTool('brush');
                else if(e.key.toLowerCase() === 'e') setTool('eraser');
                else if(e.key.toLowerCase() === 'g') setTool('fill');
                else if(e.key.toLowerCase() === 'i') setTool('pipette');
                else if(e.key.toLowerCase() === 'l') setTool('line');
                else if(e.key.toLowerCase() === 'r') setTool('rect');
                else if(e.key.toLowerCase() === 'c') setTool('circle');
                else if(e.key.toLowerCase() === 'w') setTool('magicWand');
            });
        }

        function setupZoomPan() {
            const ws = document.getElementById('workspace');
            ws.addEventListener('touchstart', (e) => {
                if(e.touches.length === 2) { e.preventDefault(); initialPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); panning = false; }
                else if(e.touches.length === 1 && !e.target.closest('.pixel')) { panning = true; lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; }
            }, {passive:false});
            ws.addEventListener('touchmove', (e) => {
                if(e.touches.length === 2) { e.preventDefault(); const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); scale = Math.min(Math.max(0.5, scale * (dist/initialPinchDist)), 4); initialPinchDist = dist; canvasWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`; }
                else if(panning && e.touches.length === 1) { e.preventDefault(); translateX += e.touches[0].clientX - lastTouchX; translateY += e.touches[0].clientY - lastTouchY; lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; canvasWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`; }
            }, {passive:false});
        }
    </script>
</body>
</html>